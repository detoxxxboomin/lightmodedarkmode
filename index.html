<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light vs Dark Mode Experiment</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 700px;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px;
            width: 95%;
        }

        /* Mode Colors */
        .light-mode-bg { background-color: #ffffff; color: #000000; }
        .light-mode-bg .container { background-color: #f9f9f9; border: 1px solid #ddd; }

        .dark-mode-bg { background-color: #121212; color: #ffffff; }
        .dark-mode-bg .container { background-color: #1e1e1e; border: 1px solid #333; }

        h1, h2 { margin-top: 0; }
        p { line-height: 1.6; font-size: 1.1rem; }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            margin-top: 20px;
            width: 100%;
            font-weight: bold;
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button.secondary { background-color: #2196F3; }
        button:hover:not(:disabled) { opacity: 0.9; }

        .hidden { display: none; }
        .survey-box { background: #eee; padding: 15px; border-radius: 8px; margin: 20px 0; color: black; }
        .question { margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ccc; }
        label { display: block; margin: 5px 0; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .dark-mode-bg th, .dark-mode-bg td { border-color: #444; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 1000; font-weight: bold; color: black;
        }

        .id-badge { font-family: monospace; background: #ddd; padding: 2px 5px; border-radius: 3px; }
        .error-banner { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f87171; }
    </style>
</head>
<body class="light-mode-bg">

    <div id="loading-overlay" class="hidden">Connecting to Cloud...</div>

    <!-- Screen 1: Intro -->
    <div id="intro-screen" class="container">
        <h1>Science Project: Light vs. Dark</h1>
        
        <!-- Setup Warning for User -->
        <div id="setup-warning" class="error-banner hidden">
            <strong>Action Needed:</strong> Your Firebase API Key is missing or invalid. 
            Please open the code and paste your actual Firebase credentials into the <code>firebaseConfig</code> section.
        </div>

        <p>Help me find out if screen colors change how we read!</p>
        
        <div class="survey-box">
            <p><strong>Environment Check:</strong></p>
            <p>What is the lighting like in your room?</p>
            <label><input type="radio" name="room-light" value="Bright"> Brightly Lit</label>
            <label><input type="radio" name="room-light" value="Dim"> Dimly Lit</label>
        </div>

        <button id="start-btn" onclick="checkSurveyAndStart()">Start Test</button>
        <button class="secondary" onclick="showDashboard()">ðŸ“Š View Results Spreadsheet</button>
        <p id="survey-error" style="color: red; display: none;">Please pick an option!</p>
    </div>

    <!-- Experiment Screens -->
    <div id="story-a-screen" class="container hidden">
        <h2>Story 1: The Lost Key</h2>
        <p>Sammy was playing in the backyard when he realized his pocket felt light. He tapped his jeans. Empty! The shiny silver key to the garden shed was gone. "Oh no," Sammy whispered. His dad needed that key to get the lawnmower.</p>
        <p>Sammy retraced his steps. He looked by the swings. Nothing. He looked inside the sandbox. Nothing but sand. He started to worry. The sun was getting hot, and he wiped sweat from his forehead.</p>
        <p>Just then, he saw a glimmer near the flower pots. A crow was hopping away from a shiny object. It was the key! The crow must have tried to steal it. Sammy grabbed the key and ran inside, happy that he had saved the day.</p>
        <button onclick="finishStoryA()">I'm Finished Reading</button>
    </div>

    <div id="quiz-a-screen" class="container hidden">
        <h2>Quiz 1</h2>
        <div class="question"><p>1. What did Sammy lose?</p>
            <label><input type="radio" name="q1" value="coin"> A gold coin</label>
            <label><input type="radio" name="q1" value="key"> A silver key</label>
        </div>
        <div class="question"><p>2. What animal was near it?</p>
            <label><input type="radio" name="q3" value="dog"> A dog</label>
            <label><input type="radio" name="q3" value="crow"> A crow</label>
        </div>
        <button onclick="submitQuizA()">Next</button>
    </div>

    <div id="break-screen" class="container hidden">
        <h1>Great Job!</h1>
        <p>Rest your eyes. Part 2 will be in <strong>Dark Mode</strong>.</p>
        <button onclick="startPartTwo()">Ready for Part 2</button>
    </div>

    <div id="story-b-screen" class="container hidden">
        <h2>Story 2: The Space Lunch</h2>
        <p>Astronaut Leo was very hungry. Being in zero gravity made doing simple things very hard. He opened his lunch bag and pulled out a peanut butter sandwich. "Finally," he said.</p>
        <p>Suddenly, the ship bumped into a tiny rock. The sandwich floated out of Leo's hand! It spun slowly in the air, drifting toward the control panel. "Don't touch the buttons!" Leo yelled at the sandwich.</p>
        <p>Leo pushed off the wall and floated across the room. He grabbed his butterfly net, which he used for science experiments. Swish! He caught the sandwich just before it hit the red emergency button. Leo sighed with relief and took a big bite.</p>
        <button onclick="finishStoryB()">I'm Finished Reading</button>
    </div>

    <div id="quiz-b-screen" class="container hidden">
        <h2>Quiz 2</h2>
        <div class="question"><p>1. What was Leo trying to eat?</p>
            <label><input type="radio" name="q4" value="pizza"> Pizza</label>
            <label><input type="radio" name="q4" value="sandwich"> A sandwich</label>
        </div>
        <div class="question"><p>2. What did he use to catch it?</p>
            <label><input type="radio" name="q6" value="net"> A butterfly net</label>
            <label><input type="radio" name="q6" value="hands"> His hands</label>
        </div>
        <button onclick="submitQuizB()">Save My Data</button>
    </div>

    <div id="results-screen" class="container hidden">
        <h1>Data Sent!</h1>
        <p>Thank you for helping with my science project.</p>
        <div id="personal-summary" style="background: #eee; padding: 10px; color: black; border-radius: 5px;"></div>
        <button onclick="location.reload()">Next Volunteer</button>
    </div>

    <div id="dashboard-screen" class="container hidden" style="max-width: 900px;">
        <h1>Project Dashboard</h1>
        <div id="dashboard-content" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>Time</th><th>User ID</th><th>Room</th><th>Light Mode</th><th>Dark Mode</th></tr>
                </thead>
                <tbody id="data-rows"></tbody>
            </table>
        </div>
        <button onclick="location.reload()">Back</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        /** * STEP 1: Replace the placeholders below with your actual Firebase config.
         * You can find this in your Firebase Console: Project Settings > General > Your Apps.
         */
        const firebaseConfig = {
            apiKey: "AIzaSyAdZU76cO6hjhQt9h0PgnLoL9hpA7eHToc",
            authDomain: "lightmodedarkmode-d6305.firebaseapp.com",
            projectId: "lightmodedarkmode-d6305",
            storageBucket: "lightmodedarkmode-d6305.firebasestorage.app",
            messagingSenderId: "394258467768",
            appId: "1:394258467768:web:ee7b55eeaeec0fbf53dd4d"
        };

        // Safeguard check for placeholder values
        const isConfigValid = firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("AIzaSyAdZU76cO6hjhQt9h0PgnLoL9hpA7eHToc");

        let app, auth, db;
        const collectionName = "experiment_results";

        if (isConfigValid) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            signInAnonymously(auth).catch(e => {
                console.error("Auth Error", e);
                if (e.message.includes("api-key-not-valid")) {
                    document.getElementById('setup-warning').classList.remove('hidden');
                }
            });

            onAuthStateChanged(auth, u => { 
                window.currentUser = u; 
                console.log("Logged in as:", u?.uid);
            });
        } else {
            // Show UI warning if user hasn't setup keys yet
            document.getElementById('setup-warning').classList.remove('hidden');
        }

        window.startTime = 0;
        window.timeA = 0;
        window.timeB = 0;
        window.scoreA = 0;
        window.scoreB = 0;
        window.roomLight = "";

        function showScreen(id) {
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.checkSurveyAndStart = () => {
            const selected = document.querySelector('input[name="room-light"]:checked');
            if (selected) {
                window.roomLight = selected.value;
                showScreen('story-a-screen');
                window.startTime = Date.now();
            } else {
                document.getElementById('survey-error').style.display = 'block';
            }
        };

        window.finishStoryA = () => {
            window.timeA = ((Date.now() - window.startTime) / 1000).toFixed(2);
            showScreen('quiz-a-screen');
        };

        window.submitQuizA = () => {
            window.scoreA = 0;
            if(document.querySelector('input[name="q1"]:checked')?.value === 'key') window.scoreA++;
            if(document.querySelector('input[name="q3"]:checked')?.value === 'crow') window.scoreA++;
            showScreen('break-screen');
        };

        window.startPartTwo = () => {
            document.body.classList.replace('light-mode-bg', 'dark-mode-bg');
            showScreen('story-b-screen');
            window.startTime = Date.now();
        };

        window.finishStoryB = () => {
            window.timeB = ((Date.now() - window.startTime) / 1000).toFixed(2);
            showScreen('quiz-b-screen');
        };

        window.submitQuizB = async () => {
            window.scoreB = 0;
            if(document.querySelector('input[name="q4"]:checked')?.value === 'sandwich') window.scoreB++;
            if(document.querySelector('input[name="q6"]:checked')?.value === 'net') window.scoreB++;
            
            if(!isConfigValid || !window.currentUser) {
                alert("The app is not connected to a database. Please check that you entered your Firebase API Key in the code.");
                return;
            }

            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                await addDoc(collection(db, collectionName), {
                    roomLight: window.roomLight, 
                    timeA: window.timeA, 
                    scoreA: window.scoreA, 
                    timeB: window.timeB, 
                    scoreB: window.scoreB,
                    userId: window.currentUser.uid,
                    timestamp: Timestamp.now()
                });
                document.getElementById('personal-summary').innerHTML = `Last Test: Light ${window.timeA}s | Dark ${window.timeB}s`;
                showScreen('results-screen');
                document.body.classList.replace('dark-mode-bg', 'light-mode-bg');
            } catch (e) {
                alert("Save Error: " + e.message);
                console.error(e);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        window.showDashboard = async () => {
            if(!isConfigValid || !window.currentUser) {
                alert("Database connection is not active. Setup your Firebase keys first.");
                return;
            }
            showScreen('dashboard-screen');
            const tbody = document.getElementById('data-rows');
            tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
            try {
                const snap = await getDocs(query(collection(db, collectionName)));
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.timestamp?.toDate().toLocaleTimeString() || "Unknown";
                    tbody.innerHTML += `<tr>
                        <td>${date}</td>
                        <td>${d.userId ? d.userId.substring(0,5) : '??'}</td>
                        <td>${d.roomLight || '??'}</td>
                        <td>${d.timeA}s (${d.scoreA}/2)</td>
                        <td>${d.timeB}s (${d.scoreB}/2)</td>
                    </tr>`;
                });
                if (snap.empty) {
                    tbody.innerHTML = "<tr><td colspan='5'>No results yet!</td></tr>";
                }
            } catch (e) { 
                alert("Load Error: " + e.message); 
                console.error(e);
            }
        };
    </script>
</body>
</html>
