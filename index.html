<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light vs Dark Mode Experiment</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 700px;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px;
            width: 95%;
        }

        /* Mode Colors */
        .light-mode-bg { background-color: #ffffff; color: #000000; }
        .light-mode-bg .container { background-color: #f9f9f9; border: 1px solid #ddd; }

        .dark-mode-bg { background-color: #121212; color: #ffffff; }
        .dark-mode-bg .container { background-color: #1e1e1e; border: 1px solid #333; }

        h1, h2 { margin-top: 0; }
        p { line-height: 1.6; font-size: 1.1rem; }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            margin-top: 20px;
            width: 100%;
            font-weight: bold;
        }

        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button.secondary { background-color: #2196F3; }
        button.warning { background-color: #f44336; margin-top: 10px; font-size: 0.8rem; }
        button:hover:not(:disabled) { opacity: 0.9; }

        .hidden { display: none; }
        .survey-box { background: #eee; padding: 15px; border-radius: 8px; margin: 20px 0; color: black; }
        .question { margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ccc; }
        label { display: block; margin: 5px 0; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .dark-mode-bg th, .dark-mode-bg td { border-color: #444; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,1); display: flex; justify-content: center;
            align-items: center; z-index: 1000; font-weight: bold; color: black;
            flex-direction: column; text-align: center; padding: 20px;
        }

        .error-banner { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f87171; font-size: 0.9rem; }
        .status-dot { height: 10px; width: 200px; background: #ccc; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .status-progress { height: 100%; width: 0%; background: #4CAF50; transition: width 0.3s; }
        
        #debug-info { 
            margin-top: 30px; 
            font-family: monospace; 
            font-size: 0.8rem; 
            color: #333; 
            max-width: 500px; 
            background: #f0f0f0; 
            padding: 20px; 
            border-radius: 8px; 
            border: 2px dashed #ccc;
        }
    </style>
</head>
<body class="light-mode-bg">

    <!-- Loading Overlay (Visible by default until Auth succeeds) -->
    <div id="loading-overlay">
        <div id="loading-text" style="font-size: 1.5rem;">Connecting to Cloud...</div>
        <div class="status-dot"><div id="status-progress" class="status-progress"></div></div>
        
        <div id="debug-info">
            <p style="color:#d32f2f; font-weight:bold; font-size: 1rem;">Connection Troubleshooter</p>
            <div id="error-log" style="background:#fff; padding:10px; border-radius:5px; margin: 10px 0; border: 1px solid #ddd; min-height: 40px; color: #d32f2f;">
                Waiting for response from Google...
            </div>
            <p style="text-align:left; margin-bottom: 5px;"><strong>Common Fixes:</strong></p>
            <ul style="text-align:left; margin-top: 0;">
                <li>Check if "Anonymous" is ON in Firebase Auth tab.</li>
                <li>Make sure you created the "Firestore" database.</li>
                <li>Check that Rules allow "read, write: if true".</li>
            </ul>
            <button class="warning" id="bypass-btn" onclick="bypassCloud()" style="display:none;">‚ö†Ô∏è Use Without Cloud (Save Locally Only)</button>
        </div>
    </div>

    <!-- Screen 1: Intro -->
    <div id="intro-screen" class="container hidden">
        <h1>Science Project: Light vs. Dark</h1>
        
        <div id="setup-warning" class="error-banner hidden">
            <strong>Database Error:</strong> <span id="error-msg">Check your Firebase settings.</span>
        </div>

        <p>Help me find out if screen colors change how we read!</p>
        
        <div class="survey-box">
            <p><strong>Environment Check:</strong></p>
            <p>What is the lighting like in your room?</p>
            <label><input type="radio" name="room-light" value="Bright"> Brightly Lit</label>
            <label><input type="radio" name="room-light" value="Dim"> Dimly Lit</label>
        </div>

        <button id="start-btn" onclick="checkSurveyAndStart()">Start Test</button>
        <button class="secondary" id="dash-btn" onclick="showDashboard()">üìä View Results Spreadsheet</button>
        <p id="survey-error" style="color: red; display: none;">Please pick an option!</p>
    </div>

    <!-- Experiment Screens -->
    <div id="story-a-screen" class="container hidden">
        <h2>Story 1: The Lost Key</h2>
        <p>Sammy was playing in the backyard when he realized his pocket felt light. He tapped his jeans. Empty! The shiny silver key to the garden shed was gone. "Oh no," Sammy whispered. His dad needed that key to get the lawnmower.</p>
        <p>Sammy retraced his steps. He looked by the swings. Nothing. He looked inside the sandbox. Nothing but sand. He started to worry. The sun was getting hot, and he wiped sweat from his forehead.</p>
        <p>Just then, he saw a glimmer near the flower pots. A crow was hopping away from a shiny object. It was the key! The crow must have tried to steal it. Sammy grabbed the key and ran inside, happy that he had saved the day.</p>
        <button onclick="finishStoryA()">I'm Finished Reading</button>
    </div>

    <div id="quiz-a-screen" class="container hidden">
        <h2>Quiz 1</h2>
        <div class="question"><p>1. What did Sammy lose?</p>
            <label><input type="radio" name="q1" value="coin"> A gold coin</label>
            <label><input type="radio" name="q1" value="key"> A silver key</label>
        </div>
        <div class="question"><p>2. What animal was near it?</p>
            <label><input type="radio" name="q3" value="dog"> A dog</label>
            <label><input type="radio" name="q3" value="crow"> A crow</label>
        </div>
        <button onclick="submitQuizA()">Next</button>
    </div>

    <div id="break-screen" class="container hidden">
        <h1>Great Job!</h1>
        <p>Rest your eyes. Part 2 will be in <strong>Dark Mode</strong>.</p>
        <button onclick="startPartTwo()">Ready for Part 2</button>
    </div>

    <div id="story-b-screen" class="container hidden">
        <h2>Story 2: The Space Lunch</h2>
        <p>Astronaut Leo was very hungry. Being in zero gravity made doing simple things very hard. He opened his lunch bag and pulled out a peanut butter sandwich. "Finally," he said.</p>
        <p>Suddenly, the ship bumped into a tiny rock. The sandwich floated out of Leo's hand! It spun slowly in the air, drifting toward the control panel. "Don't touch the buttons!" Leo yelled at the sandwich.</p>
        <p>Leo pushed off the wall and floated across the room. He grabbed his butterfly net, which he used for science experiments. Swish! He caught the sandwich just before it hit the red emergency button. Leo sighed with relief and took a big bite.</p>
        <button onclick="finishStoryB()">I'm Finished Reading</button>
    </div>

    <div id="quiz-b-screen" class="container hidden">
        <h2>Quiz 2</h2>
        <div class="question"><p>1. What was Leo trying to eat?</p>
            <label><input type="radio" name="q4" value="pizza"> Pizza</label>
            <label><input type="radio" name="q4" value="sandwich"> A sandwich</label>
        </div>
        <div class="question"><p>2. What did he use to catch it?</p>
            <label><input type="radio" name="q6" value="net"> A butterfly net</label>
            <label><input type="radio" name="q6" value="hands"> His hands</label>
        </div>
        <button onclick="submitQuizB()">Save My Data</button>
    </div>

    <div id="results-screen" class="container hidden">
        <h1>Data Sent!</h1>
        <p>Thank you for helping with my science project.</p>
        <div id="personal-summary" style="background: #eee; padding: 10px; color: black; border-radius: 5px;"></div>
        <button onclick="location.reload()">Next Volunteer</button>
    </div>

    <div id="dashboard-screen" class="container hidden" style="max-width: 900px;">
        <h1>Project Dashboard</h1>
        <div id="dashboard-content" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr><th>Time</th><th>User ID</th><th>Room</th><th>Light Mode</th><th>Dark Mode</th></tr>
                </thead>
                <tbody id="data-rows"></tbody>
            </table>
        </div>
        <button onclick="location.reload()">Back</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdZU76cO6hjhQt9h0PgnLoL9hpA7eHToc",
            authDomain: "lightmodedarkmode-d6305.firebaseapp.com",
            projectId: "lightmodedarkmode-d6305",
            storageBucket: "lightmodedarkmode-d6305.appspot.com",
            messagingSenderId: "394258467768",
            appId: "1:394258467768:web:ee7b55eeaeec0fbf53dd4d"
        };

        let app, auth, db, resultsRef;
        let currentUser = null;
        let isBypassed = false;

        const logError = (err) => {
            const el = document.getElementById('error-log');
            if(el) el.innerText = err;
            console.error("Firebase Error:", err);
        };

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            resultsRef = collection(db, 'experiment_results');

            signInAnonymously(auth).then(cred => {
                currentUser = cred.user;
                document.getElementById('status-progress').style.width = "100%";
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('intro-screen').classList.remove('hidden');
            }).catch(e => {
                logError(e.code + ": " + e.message);
                if(e.code === "auth/operation-not-allowed") {
                    logError("CRITICAL: You must enable 'Anonymous' sign-in in the Firebase Console!");
                }
            });
        } catch (e) {
            logError("Initialization Failed: " + e.message);
        }

        // Show Bypass Button after 8 seconds
        setTimeout(() => {
            if (!currentUser) {
                document.getElementById('bypass-btn').style.display = 'block';
                document.getElementById('loading-text').innerText = "Connection Taking Too Long...";
            }
        }, 8000);

        window.bypassCloud = () => {
            isBypassed = true;
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('intro-screen').classList.remove('hidden');
            document.getElementById('setup-warning').classList.remove('hidden');
            document.getElementById('error-msg').innerText = "Running in Local Mode (Offline). Data will not be saved to the cloud.";
            document.getElementById('dash-btn').disabled = true;
        };

        // App Logic
        window.startTime = 0;
        window.timeA = 0;
        window.timeB = 0;
        window.scoreA = 0;
        window.scoreB = 0;
        window.roomLight = "";

        function showScreen(id) {
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.checkSurveyAndStart = () => {
            const selected = document.querySelector('input[name="room-light"]:checked');
            if (selected) {
                window.roomLight = selected.value;
                showScreen('story-a-screen');
                window.startTime = Date.now();
            } else {
                document.getElementById('survey-error').style.display = 'block';
            }
        };

        window.finishStoryA = () => {
            window.timeA = ((Date.now() - window.startTime) / 1000).toFixed(2);
            showScreen('quiz-a-screen');
        };

        window.submitQuizA = () => {
            window.scoreA = 0;
            if(document.querySelector('input[name="q1"]:checked')?.value === 'key') window.scoreA++;
            if(document.querySelector('input[name="q3"]:checked')?.value === 'crow') window.scoreA++;
            showScreen('break-screen');
        };

        window.startPartTwo = () => {
            document.body.classList.replace('light-mode-bg', 'dark-mode-bg');
            showScreen('story-b-screen');
            window.startTime = Date.now();
        };

        window.finishStoryB = () => {
            window.timeB = ((Date.now() - window.startTime) / 1000).toFixed(2);
            showScreen('quiz-b-screen');
        };

        window.submitQuizB = async () => {
            window.scoreB = 0;
            if(document.querySelector('input[name="q4"]:checked')?.value === 'sandwich') window.scoreB++;
            if(document.querySelector('input[name="q6"]:checked')?.value === 'net') window.scoreB++;
            
            if(isBypassed) {
                document.getElementById('personal-summary').innerHTML = `Local Mode: Light: ${window.timeA}s | Dark: ${window.timeB}s`;
                showScreen('results-screen');
                return;
            }

            try {
                await addDoc(resultsRef, {
                    roomLight: window.roomLight, 
                    timeA: parseFloat(window.timeA), 
                    scoreA: window.scoreA, 
                    timeB: parseFloat(window.timeB), 
                    scoreB: window.scoreB,
                    userId: currentUser?.uid || "unknown",
                    timestamp: Timestamp.now()
                });
                
                document.getElementById('personal-summary').innerHTML = `Success! Light: ${window.timeA}s | Dark: ${window.timeB}s`;
                showScreen('results-screen');
                document.body.classList.replace('dark-mode-bg', 'light-mode-bg');
            } catch (e) {
                alert("Cloud Save Failed: " + e.message);
            }
        };

        window.showDashboard = async () => {
            showScreen('dashboard-screen');
            const tbody = document.getElementById('data-rows');
            tbody.innerHTML = "<tr><td colspan='5'>Loading spreadsheet...</td></tr>";
            try {
                const snap = await getDocs(query(resultsRef));
                tbody.innerHTML = "";
                const items = [];
                snap.forEach(doc => items.push(doc.data()));
                items.sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                items.forEach(d => {
                    const date = d.timestamp?.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) || "??";
                    tbody.innerHTML += `<tr>
                        <td>${date}</td>
                        <td>${d.userId ? d.userId.substring(0,5) : '??'}</td>
                        <td>${d.roomLight || '??'}</td>
                        <td>${d.timeA}s (${d.scoreA}/2)</td>
                        <td>${d.timeB}s (${d.scoreB}/2)</td>
                    </tr>`;
                });
                if (items.length === 0) tbody.innerHTML = "<tr><td colspan='5'>No results found.</td></tr>";
            } catch (e) { 
                tbody.innerHTML = `<tr><td colspan='5' style="color:red">Error: ${e.message}</td></tr>`;
            }
        };
    </script>
</body>
</html>
